#!/bin/bash
# tf-git CLI - handles init command and passes through to terraform wrapper

set -e

# Function to detect existing provider blocks
detect_existing_provider() {
  local provider="$1"
  local provider_file=""
  local provider_line=""
  
  # Search for existing provider blocks
  for file in *.tf; do
    [ -f "$file" ] || continue
    if grep -q "provider \"$provider\"" "$file"; then
      provider_file="$file"
      provider_line=$(grep -n "provider \"$provider\"" "$file" | head -1 | cut -d: -f1)
      echo "$provider_file:$provider_line"
      return 0
    fi
  done
  
  return 1
}

# Function to generate provider patch
generate_provider_patch() {
  local provider="$1"
  local provider_file="$2"
  local provider_line="$3"
  
  case "$provider" in
    aws)
      cat <<EOF

# Add this default_tags block to your existing provider "aws" block:
  default_tags {
    tags = {
      git_sha    = var.git_sha
      git_branch = var.git_branch
      git_repo   = var.git_repo
    }
  }
EOF
      ;;
    azurerm)
      cat <<EOF

# Azure doesn't support provider-level default_tags like AWS.
# Instead, add this locals block to your Terraform configuration:

locals {
  default_tags = {
    git_sha    = var.git_sha
    git_branch = var.git_branch
    git_repo   = var.git_repo
  }
}

# Then add tags to each resource:
#   tags = local.default_tags
#
# Example:
# resource "azurerm_storage_account" "example" {
#   name     = "example"
#   ...
#   tags = local.default_tags
# }
EOF
      ;;
    google)
      cat <<EOF

# GCP uses labels instead of tags, and provider-wide defaults aren't uniform.
# Add this locals block to your Terraform configuration:

locals {
  default_labels = {
    git_sha    = var.git_sha
    git_branch = var.git_branch
    git_repo   = var.git_repo
  }
}

# Then add labels to each resource:
#   labels = local.default_labels
#
# Example:
# resource "google_storage_bucket" "example" {
#   name     = "example"
#   ...
#   labels = local.default_labels
# }
#
# See: https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference#labels
EOF
      ;;
  esac
}

# Function to generate tf-git.auto.tf
run_init() {
  local filename="tf-git.auto.tf"
  
  # Check if file already exists
  if [ -f "$filename" ]; then
    echo "âš ï¸  tf-git.auto.tf already exists â€” aborting to avoid overwrite"
    echo "   Delete the file first if you want to regenerate it"
    return 1
  fi
  
  # Detect provider by checking existing .tf files
  local provider="azurerm"
  local provider_found=false
  
  if grep -r "provider \"aws\"" *.tf 2>/dev/null | grep -q .; then
    provider="aws"
    provider_found=true
  elif grep -r "provider \"google\"" *.tf 2>/dev/null | grep -q .; then
    provider="google"
    provider_found=true
  elif grep -r "provider \"azurerm\"" *.tf 2>/dev/null | grep -q .; then
    provider="azurerm"
    provider_found=true
  fi
  
  # Check if provider block already exists
  local existing_provider=""
  if [ "$provider_found" = true ]; then
    existing_provider=$(detect_existing_provider "$provider")
  fi
  
  if [ -n "$existing_provider" ]; then
    # Provider block exists - generate variables file and patch instructions
    local provider_file=$(echo "$existing_provider" | cut -d: -f1)
    local provider_line=$(echo "$existing_provider" | cut -d: -f2)
    
    # Write variables file
    cat > "$filename" <<EOF
# ===============================================
# tf-git generated file
# ===============================================
# This file was generated by 'tf-git init'
# It auto-configures Git tagging in Terraform.
# Safe to delete! Do not modify the generated file.
# ===============================================

variable "git_sha" {
  type    = string
  default = "unknown"
}

variable "git_branch" {
  type    = string
  default = "unknown"
}

variable "git_repo" {
  type    = string
  default = "unknown"
}
EOF
    
    echo ""
    echo "âœ¨ Created tf-git.auto.tf (variables only)"
    echo ""
    echo "âš ï¸  Provider block already exists in: $provider_file (line $provider_line)"
    echo ""
    echo "To enable automatic tagging, add the following to your existing"
    echo "provider \"$provider\" block in $provider_file:"
    echo ""
    generate_provider_patch "$provider" "$provider_file" "$provider_line"
    echo ""
    echo "After adding default_tags, commit both files:"
    echo "  git add tf-git.auto.tf $provider_file"
    echo "  git commit -m \"Enable tf-git Terraform tagging\""
    echo ""
    
  else
    # No provider block exists - generate complete file
    local provider_block=""
    case "$provider" in
      aws)
        provider_block="provider \"aws\" {
  default_tags {
    tags = {
      git_sha    = var.git_sha
      git_branch = var.git_branch
      git_repo   = var.git_repo
    }
  }
}"
        ;;
      google)
        provider_block="provider \"google\" {
  # GCP configuration
}

# Default labels that can be applied to resources
# Note: GCP uses labels instead of tags, and provider-wide defaults aren't uniform.
# You may need to add labels per resource or use a module.
locals {
  default_labels = {
    git_sha    = var.git_sha
    git_branch = var.git_branch
    git_repo   = var.git_repo
  }
}

# Example usage:
# resource \"google_storage_bucket\" \"example\" {
#   name     = \"example\"
#   ...
#   labels = local.default_labels
# }
#
# See: https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference#labels
"
        ;;
      azurerm)
        provider_block="provider \"azurerm\" {
  features {}
}

# Default tags that will be applied to all resources
locals {
  default_tags = {
    git_sha    = var.git_sha
    git_branch = var.git_branch
    git_repo   = var.git_repo
  }
}"
        ;;
    esac
    
    # Write the complete file
    cat > "$filename" <<EOF
# ===============================================
# tf-git generated file
# ===============================================
# This file was generated by 'tf-git init'
# It auto-configures Git tagging in Terraform.
# Safe to delete! Do not modify the generated file.
# ===============================================

variable "git_sha" {
  type    = string
  default = "unknown"
}

variable "git_branch" {
  type    = string
  default = "unknown"
}

variable "git_repo" {
  type    = string
  default = "unknown"
}

$provider_block
EOF
    
    echo ""
    echo "âœ¨ Created tf-git.auto.tf"
    echo "âœ”  Git tagging configured automatically (detected provider: $provider)"
    echo "ðŸ” Safe to delete the file if you change your tagging strategy"
    echo "ðŸ“ Commit the file if you want permanent tagging"
    echo ""
  fi
}

# Handle init command
if [ "$1" = "init" ]; then
  run_init
  exit $?
fi

# For all other commands, pass through to terraform wrapper
exec terraform "$@"
