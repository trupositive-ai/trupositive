#!/bin/bash
# Terraform wrapper that automatically injects Git metadata as variables
# PRODUCTION-READY VERSION with dynamic binary discovery

set -e

# Extract Git metadata
GIT_SHA=$(git rev-parse HEAD 2>/dev/null || echo "")

# Try to get branch name with better CI/detached HEAD handling
GIT_BRANCH=$(git symbolic-ref --short -q HEAD 2>/dev/null || \
  git rev-parse --abbrev-ref HEAD 2>/dev/null || \
  echo "${GITHUB_REF_NAME:-${CI_COMMIT_REF_NAME:-${BUILD_SOURCEBRANCHNAME:-${BRANCH_NAME:-HEAD}}}}")

GIT_REPO=$(git config --get remote.origin.url 2>/dev/null || echo "")

# Export as Terraform variables
export TF_VAR_git_sha="$GIT_SHA"
export TF_VAR_git_branch="$GIT_BRANCH"
export TF_VAR_git_repo="$GIT_REPO"

# Find terraform binary dynamically
# Priority: terraform-real (from installation) > which terraform > terraform in PATH
if [ -f ~/.local/bin/terraform-real ]; then
    TERRAFORM_BIN=~/.local/bin/terraform-real
elif command -v terraform-real >/dev/null 2>&1; then
    TERRAFORM_BIN=$(command -v terraform-real)
elif command -v terraform >/dev/null 2>&1; then
    TERRAFORM_BIN=$(command -v terraform)
else
    echo "Error: terraform binary not found. Please install Terraform." >&2
    exit 1
fi

# Pass through all arguments to terraform
exec "$TERRAFORM_BIN" "$@"
